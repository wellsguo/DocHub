
## 一 前言

在单一的服务器上执行WEB应用程序有一些重大的问题，当网站成功建成并开始接受大量请求时，单一服务器终究无法满足需要处理的负荷量，所以就有点显得有点力不从心了。另外一个常见的问题是会产生单点故障，如果该服务器坏掉，那么网站就立刻无法运作了。不论是因为要有较佳的扩充性还是容错能力，我们都会想 在一台以上的服务器计算机上执行WEB应用程序。所以，这时候我们就需要用到集群这一门技术了。

### 术语

1. **集群(Cluster)**：是一组独立的计算机系统构成一个松耦合的多处理器系统，它们之间通过网络实现进程间的通信。应用程序可以通过网络共享内存进行消息传送，实现分布式计算机。

2. **负载均衡(Load Balance)**：先得从集群讲起，集群就是一组连在一起的计算机，从外部看它是一个系统，各节点可以是不同的操作系统或不同硬件构成的计算机。如一个提供Web服务的集群，对外界来看是一个大Web服务器。不过集群的节点也可以单独提供服务。    
**特点**：在现有网络结构之上，负载均衡提供了一种廉价有效的方法扩展服务器带宽和增加吞吐量，加强网络数据处理能力，提高网络的灵活性和可用性。


### 主要解决问题  

  - **高可靠性（HA）**：利用集群管理软件，当主服务器故障时，备份服务器能够自动接管主服务器的工作，并及时切换过去，以实现对用户的不间断服务。 
  - **高性能计算（HP）**：即充分利用集群中的每一台计算机的资源，实现复杂运算的并行处理，通常用于科学计算领域，比如基因分析，化学分析等。 
  - **负载平衡**：即把负载压力根据某种算法合理分配到集群中的每一台计算机上，以减轻主服务器的压力，降低对主服务器的硬件和软件要求。

总体来说，在负载均衡的思路下，多台服务器为对等方式，每台服务器都具有同等的地位，可以单独对外提供服务而无须其他服务器的辅助。通过负载分担技术，将外部发送来的请求按一定规则分配到对称结构中的某一台服务器上，而接收到请求的服务器都独立回应客户机的请求。

提供服务的一组服务器组成了一个应用服务器集群(cluster)，集群下的对等多机环境可以增加系统的并发处理能力，和单台机器出现故障系统的错误冗余能力；同时实现了负载均衡和系统高可靠性。

## 二 常用负载均衡技术

1. **基于DNS的负载均衡**  
通过DNS服务中的随机名字解析来实现负载均衡，在DNS服务器中，可以为多个不同的地址配置同一个名字，而最终查询这个名字的客户机将在解析这个名字时 得到其中一个地址。因此，对于同一个名字，不同的客户机会得到不同的地址，他们也就访问不同地址上的Web服务器，从而达到负载均衡的目的。

2. **反向代理负载均衡** （如Apache+JK2+Tomcat这种组合）  
使用代理服务器可以将请求转发给内部的Web服务器，让代理服务器将请求均匀地转发给多台内部Web服务器之一上，从而达到负载均衡的目的。这种代理方式 与普通的代理方式有所不同，标准代理方式是客户使用代理访问多个外部Web服务器，而这种代理方式是多个客户使用它访问内部Web服务器，因此也被称为反 向代理模式。

3. **基于NAT（Network Address Translation）的负载均衡技术** （如Linux Virtual Server，简称LVS）  
网络地址转换为在内部地址和外部地址之间进行转换，以便具备内部地址的计算机能访问外部网络，而当外部网络中的计算机访问地址转换网关拥有的某一外部地址 时，地址转换网关能将其转发到一个映射的内部地址上。因此如果地址转换网关能将每个连接均匀转换为不同的内部服务器地址，此后外部网络中的计算机就各自与 自己转换得到的地址上服务器进行通信，从而达到负载分担的目的。

### 软件负载均衡服务介绍

软件负载均衡服务一般分为两种：四层负载均衡和七层负载均衡，四层和七层指的是负载均衡服务运行的位置，分别对应ISO网络协议中的传输层和网络层。在实际应用中，四层负载均衡一般就是位于层的TCP协议（或者SSL协议）的负载均衡，而七层负载均衡就是HTTP协议（或者HTTPS）协议的负载均衡。

除此之外，还有针对ICMP，POP3邮件协议，针对数据库协议的负载均衡等，但应用最为广泛的，还是基于HTTP和TCP协议负载均衡，这也是由于实际应用环境决定的：HTTP协议是现在应用最为广泛的应用层协议，也是基于“页面”的老一代互联网的基础，得到了极为广泛的应用，可以说，HTTP协议就是互联网技术最重要的协议。而TCP协议作为传输层的基础协议，可以直接兼容应用层的各种协议。在实际的应用场景中，对于web服务，直接使用HTTP负载均衡，而对于需要长连接的，或者其他非HTTP协议的服务，如mysql，redis等，则统一使用TCP负载均衡。

常见的负载均衡服务有**Apache，LVS，Nginx，Haproxy**等：

- 按照类型看，Apache，Nginx属于七层负载均衡，LVS属于四层负载均衡，Haproxy同时支持四层和七层负载均衡。

- 按照功能看，LVS，Haproxy是专门的负载均衡服务器，Apache和Nginx除了作为负载均衡服务器外，还可以作为独立的web服务器，直接提供web服务。



## 常用服务器

### 应用服务器和 HTTP 服务器

Apache/Nginx 应该叫做 **「HTTP Server」**；而 Tomcat 则是一个 **「Application Server」**，或者更准确的来说，是一个「Servlet/JSP」应用的容器（Ruby/Python 等其他语言开发的应用也无法直接运行在 Tomcat 上）。

一个 HTTP Server 关心的是 HTTP **协议层面的传输和访问控制**，所以在 Apache/Nginx 上你可以看到代理、负载均衡等功能。客户端通过 HTTP Server 访问服务器上存储的资源（HTML 文件、图片文件等等）。通过 CGI 技术，也可以将处理过的内容通过 HTTP Server 分发，但是一个 HTTP Server 始终只是把服务器上的文件如实的通过 HTTP 协议传输给客户端。

而应用服务器，则是一个应用执行的容器。它首先需要支持开发语言的 Runtime（对于 Tomcat 来说，就是 Java），保证应用能够在应用服务器上正常运行。其次，需要支持应用相关的规范，例如类库、安全方面的特性。对于 Tomcat 来说，就是需要提供 JSP/Sevlet 运行需要的标准类库、Interface 等。为了方便，应用服务器往往也会集成 HTTP Server 的功能，但是不如专业的 HTTP Server 那么强大，所以应用服务器往往是运行在 HTTP Server 的背后，执行应用，将动态的内容转化为静态的内容之后，通过 HTTP Server 分发到客户端。

一般的运用场景下，apache 和 nginx 在负载均衡里是前端服务器，用来处理请求的转发（反向代理等）；绝大部分时候他们本身并不会运行项目。tomcat 和 jetty，WebLogic 是后端服务器，是直接用来运行项目的容器。 
简单来说就是你发出一个请求，先经过 apache 或 nginx，他们会合理地把请求分配到后台比较不忙的 tomcat 或 jetty。tomcat 或 jetty会把请求处理好返回给 apache 或 nginx，然后a或n会把最终的请求结果告诉你。当然，如果是一些静态的数据，a 和 n就可以直接返回给你了。

### 服务器介绍

- **Apache HTTP Server**  
Apache 软件基金会的一个开放源代码的网页服务器软件，可以在大多数电脑操作系统中运行，由于其跨平台和安全性被广泛使用，是最流行的Web服务器软件之一。它快速、可靠并且可通过简单的 API 扩充，将 Perl/Python 等解释器编译到服务器中。  
![Apache处理http请求的生命周期](https://ask.qcloudimg.com/http-save/developer-news/bipcxkz5k8.jpeg?imageView2/2/w/1620)

- **Nginx**  
Nginx 是轻量级的 HTTP 服务器，是一个高性能的 HTTP 和反向代理服务器，同时也是一个 IMAP/POP3/SMTP 代理服务器。  
![Nginx架构](https://ask.qcloudimg.com/http-save/developer-news/nq4ub2dlzn.jpeg?imageView2/2/w/1620)

- **Tomcat**  
Tomcat 是由 Apache 软件基金会下属的 Jakarta 项目开发的一个Servlet容器，实现了对Servlet和JavaServer Page（JSP）的支持，也可称为是Servlet和JSP 容器。对 web 程序来说，容器的作用就相当于桌面程序里操作系统的作用，提供一些编程基础设施并提供了作为Web服务器的一些特有功能，可以运行自己编写的servlet应用程序处理动态请求。由于Tomcat本身也内含了一个HTTP服务器，它也可以被视作一个单独的Web服务器。但是，不能将Tomcat和Apache HTTP服务器混淆，Apache HTTP服务器是一个用C语言实现的HTTP Web服务器；这两个HTTP web server不是捆绑在一起的。

### 服务器比较

#### Apache vs Tomcat

1. Apache是 Web 服务器，Web 服务器传送(serves)页面使浏览器可以浏览，Web 服务器专门处理HTTP请求(request)，但是应用程序服务器是通过很多协议来为应用程序提供 (serves)业务逻辑(business logic)。  
Tomcat 是运行在 Apache 上的应用服务器，应用程序服务器提供的是客户端应用程序可以调用(call)的方法 (methods)。可以认为是Apache的扩展，但是可以独立于Apache运行。

2. Apache 是普通服务器，本身只支持 HTML 静态普通网页。Tomcat 是 JSP/servlet 容器，同时还支持 HTML、JSP、ASP、PHP、CGI等。

3. Apache 侧重于 http server，Tomcat 侧重于 servlet 引擎，如果以 standalone 方式运行，功能上 Tomcat 与 Apache 等效支持JSP，但对静态网页不太理想。

4. Apache 可以运行一年不重启，稳定性非常好，而 Tomcat 则不见得。

5. 首选 web 服务器是 Apache，当遇到 Apache 解析不了的 JSP、servlet 才用 Tomcat。

6. Apache 是由 C 语言实现的，支持各种特性和模块从而来扩展核心功能；Tomcat 是 Java 编写的，更好的支持 Servlet 和 JSP。Apache 不能解析 java 的东西，但解析 HTML 速度快。

#### Apache vs Nginx

1. Apache 处理速度很慢，占用很多内存资源，Nginx 相对 Apache 是轻量级的，同样的 web 服务，比 Apache 占用更少的内存及资源抗并发。Nginx 处理请求是异步非阻塞的，而 Apache 则是阻塞型的，在高并发下 Nginx 能保持低资源低消耗高性能。在 Apache+PHP（prefork）模式下，如果 PHP 处理慢或者前端压力很大的情况下，很容易出现 Apache 进程数飙升，从而拒绝服务的现象

2. 功能实现上，Apache 所有模块支持动静态编译，Nginx 模块都是静态编译的

3. 对 FCGI 的支持上，Nginx 支持效果比 Apache 的支持好很多

4. 处理连接方式，Nginx 支持 epoll, Apache 不支持

5. 空间使用上，Nginx 安装包仅几百K

6. 静态处理上，Nginx 静态处理性能比 Apache 高 3倍以上

7. 模块化上，Nginx 的高度模块化的设计，编写模块相对简单，社区活跃，模块更新速度很快。而Apache出现的较早，现有模块非常多，常见的都可以找到。  
对于web服务，如果稳定性的需求高于性能和效率需求，就用Apache，反之则选择Nginx。当然，可以同时使用Apache和Nginx。

#### 小结

- Apache  
是静态解析，适合静态HTML、图片等。相对于Tomcat服务器来说处理静态文件是它的优势，速度快。apache 用的越来越少了，大体上和nginx功能重合的更多。

- Nginx  
优势在于负载均衡、反向代理和处理静态文件。相对于Apache服务器来说处理静态请求的速度更快。

- Tomcat  
动态解析容器，处理动态请求，是编译JSP\Servlet的容器，Nginx有动态分离机制，静态请求直接就可以通过Nginx处理，动态请求才转发请求到后台交由Tomcat进行处理。

### 技术指标和选型

#### 从应用方面

- tomcat   
一般是做动态解析才会用得到，支持jsp的解析，需要配置JDK支持。对应的服务器有 jboss,jetty 等。

- nginx   
一般是做静态，本身不具备动态解析功能，需要配置其他插件或通过其他软件协同才具备动态功能，比如php，tomcat，或者 proxypass 到 win2008 的 iis 服务器做 ASP 的动态链接等。

#### 在性能方面 

> 如果在不做系统调优的情况下 

- tomcat  
一般支持并发并不高100个差不多了   

- nginx  
在静态方面支持并发轻松达几万


