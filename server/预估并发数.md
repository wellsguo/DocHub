# 如何准确估算并发数？



这次活动带给我最深刻的印象就是：由于业务流程中的预见性准备不足，导致用户大量流失、后期硬件资源过剩造成浪费，但最恐怖的还是连随附带的负面影响。为此，在日后举行大型活动前，必须得从用户使用的角度、从程序承受能力、及活动的目的几方面考虑。

而目前最让人头疼的就是如何才能够准确地估算用户情况，避免同类情况的发生？这里需要先了解并确认以下几个数据：
    1. 同时在线用户数
    2. 平均并发数
    3. 并发用户数峰值

在实际的性能测试工作中，测试人员一般比较关心的是业务并发用户数，也就是从业务角度关注究竟应该设置多少个并发数比较合理，因此，在后面的讨论中，也是主要针对业务并发用户数进行讨论，而且，为了方便，直接将业务并发用户数称为并发用户数。

   （1） 计算平均的并发用户数： $$ C = nL/T$$  
   > 即：平均并发数＝总用户数*用户在线时长/总工作时间 

   （2） 并发用户数峰值：$$ C’ ≈ C+3 \times \sqrt C$$
   > 即：峰值并发数＝平均并发数+3*（平均并发数^1/2）

  公式（1）中，C是平均的并发用户数；n是login session的数量；L是login session的平均长度；T指考察的时间段长度。

  公式（2）则给出了并发用户数峰值的计算方式中，其中，C’指并发用户数的峰值，C就是公式（1）中得到的平均的并发用户数。该公式的得出是假设用户的login session产生符合泊松分布而估算得到的。

#### 实例

 假设有一个OA系统，该系统有3000个用户，平均每天大约有400个用户要访问该系统，对一个典型用户来说，一天之内用户从登录到退出该系统的平均时间为4小时，在一天的时间内，用户只在8小时内使用该系统。

则根据公式（1）和公式（2），可以得到：

​       $$C = 400 * 4 ÷ 8 = 200$$

​       $$C’≈200+3* \sqrt 200 = 242.1$$

## **估算处理能力**

通常用TPC-C值，即每分钟处理请求。每个服务器也把TPCC值作为指标。这与以下因素有关：
1. 并发用户数？（$$U_1$$）
2. 用户访问模式：每分钟每个用户发出的业务请求个数，例如0.2个（$N_1$）
3. 这些业务请求中，
如果是数据库服务器，就统计查询、更新、统计占比，
如果是Web服务器，可统计，例如连接跳转、添加操作、删除操作、更新操作，查询操作除各占1/5
4. 业务请求引起的事务数量
例如， 平均每次页面跳转操作产生6个事务（$T_1$），平均每次添加操作产生8个事务（$T_2$）；平均每次删除操作产生8个事务（$T_3$）；平均每次更新操作产生14个事务（$T_4$）； 平均每次查询操作产生10个事务（$T_5$）；
5. 忙时数量是平均值几倍，例如5倍
6. 经验系数，例如1.8
7. 服务器保留多少冗余，一般是30%
 $$TPC-C = U_1 \times N_1 \times（T_1+T_2+T_3+ T_4+ T_5）/ 5 \times 3 \times经验系数 / 冗余系$$

 参考：[“并发用户数”和“系统用户数”之间的差](http://tech.it168.com/a2009/0115/263/000000263110.shtml)

 



# 怎么估算并发量（以千万PV网站为例）

要估算并发，首先是获取PV（Page View），即一天内用户访问页面的数量，这个数量你可以想想用什么办法获取，比如根据已有系统估算、根据日志数据获取等等，这里举例说千万PV的一个网站吧。

有了PV，接着估算一天内承载压力最高的时段，比如你的网站一天内就是晚八点到晚十二点压力最高，那就是4小时，有了时间段，还要再知道这四小时承载了多少流量，比如可以估算为80%的流量。当然如果不能准确估计这个时间和流量，也可以粗略算一天80%的流量集中在20%的时间内，然后就可以算并发量（QPS）了。

QPS就是并发量的一个标准单位，表示query per second，每秒请求次数，既能反映服务器处理并发的能力，也能反映外部请求的峰值，我们做压测时，就会看QPS最后达到的顶峰，以此来记录服务器、应用程序处理并发网络请求的能力，你在预估外部并发量时，也要算这个值，这个公式就很简单：$$QPS = PV/(HOUR \times 60 \times 60) $$，拿刚刚的例子来说，结果就是

QPS = (1000w * 80%)/(4 * 60 * 60)=555.556

也就是说你的网站现在估算出来QPS峰值是555.556，那么你服务器载荷就要达到这个要求，才能保证不会宕机。

那现在你对一台机器进行压测，得到其QPS为80，这就简单了，555.556 / 80 = 6.94445，向上取整为7，也就是你要7台服务器才能顶得住用户请求的峰值。